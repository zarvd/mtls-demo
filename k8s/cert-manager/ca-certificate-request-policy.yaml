apiVersion: policy.cert-manager.io/v1alpha1
kind: CertificateRequestPolicy
metadata:
  name: allow-serving-cert
spec:
  selector:
    issuerRef:
      name: ca-issuer
      kind: ClusterIssuer
  allowed:
    isCA: false
    usages:
      - "server auth"
      - "digital signature"
      - "key encipherment"
    commonName:
      required: true
      value: "*.*.svc.cluster.local"
    dnsNames:
      required: true
      values:
        - "*.*.svc.cluster.local"
---
apiVersion: policy.cert-manager.io/v1alpha1
kind: CertificateRequestPolicy
metadata:
  name: allow-client-cert
spec:
  selector:
    issuerRef:
      name: ca-issuer
      kind: ClusterIssuer
  allowed:
    isCA: false
    usages:
      - "client auth"
      - "digital signature"
    commonName:
      required: true
      value: "*.*.svc.cluster.local"
    dnsNames:
      required: true
      values:
        - "*.*.svc.cluster.local"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-policy:ca-issuer
rules:
  - apiGroups: ["policy.cert-manager.io"]
    resources: ["certificaterequestpolicies"]
    verbs: ["use"]
    resourceNames: ["allow-serving-cert", "allow-client-cert"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-manager-policy:ca-issuer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-manager-policy:ca-issuer
subjects:
  - kind: Group
    name: system:authenticated
    apiGroup: rbac.authorization.k8s.io
